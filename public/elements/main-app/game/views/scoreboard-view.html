<!-- Polymer -->
<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<!-- Networking -->
<link rel="import" href="../../../../bower_components/iron-ajax/iron-ajax.html"/>
<!-- <script src="/socket.io/socket.io.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.slim.js"></script>

<!-- Styles -->
<link rel="import" href="../game-app-styles.html">
<link rel="import" href="./styles/scoreboard-view-styles.html">

<!-- Predix components -->
<link rel="import" href="../../../../bower_components/px-modal/px-modal.html"/>

<!-- Bootstrap -->
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Font awesome -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<dom-module id="scoreboard-view">
  <template>
    <!-- Local theme -->
    <style include="game-app-styles" is="custom-style"></style>
    <style include="scoreboard-view-styles" is="custom-style"></style>

    <!-- STATE: Page is loading -->
    <template is="dom-if" if="{{pageIsLoading}}">
      <px-progress-bar
        value="100"
        min="0"
        max="100"
        infinite>
      </px-progress-bar>
    </template>

    <!-- STATE: Page is not loading -->
    <template is="dom-if" if="{{!pageIsLoading}}">
      <!-- STATE: Page is not loading and has an error -->
      <template is="dom-if" if="{{pageHasError}}">
        <div role="error" id="container--error">
          <h1>Error receiving data</h1>
          <p>Please report the following error message <a target="_blank" href="https://github.com/Foolish-Foosballers/Foosball-Front-End/issues">here</a>.</p>
          <div id="container--error-message">{{error}}</div>
        </div>
      </template>
    
    <!-- STATE: Page is not loading and does not have an error -->
    <template is="dom-if" if="{{!pageHasError}}">
      <body>
      <div class="container container-fluid">
          
        <!-- Scoreboard -->
        <div id="container--scoreboard">

          <!-- Black side -->
          <div id="container--player-scoreboard">
            <div id="container--player-details">
              <p>
                <i class="fa fa-circle" aria-hidden="true" id="icon--black"></i>
                <span id="black--name" class="name"></span>
              </p>
            </div>
            <p id="black--score" class="score">{{gameObject.blackScore}}</p>
          </div>

          <!-- Menu -->
          <div id="menu">
              <div id="menu--timer">
                <span id="minutes">{{gameObject.timer.minutes}}</span>:<span id="seconds">{{gameObject.timer.seconds}}</span> 
              </div>
              <div id="menu--options">
                  <a id="button--restart-game" on-tap="_restartGame" class="game-option"><i class="fa fa-repeat fa-3x" aria-hidden="true"></i></a>
                  <a id="pause-play" class="game-option"><i class="fa fa-pause fa-3x" aria-hidden="true"></i></a>
                  <form id="quit--form" action="/" class="game-option">
                    <a id="button--quit-game" on-tap="_quitGame" class="game-option"><i class="fa fa-sign-out fa-3x" aria-hidden="true"></i></a>
                  </form>
              </div> 

              <px-modal
                btn-modal-positive="Confirm Changes"
                btn-modal-negative="Cancel"
                modal-heading="Edit player names and scores below.">
                <button id="button--edit-game" type="button" class="menu-button btn btn btn--primary modal-trigger">Edit</button>
                <div class="modal-body">
                  <div class="modal-row">
                    <div class="modal-col">
                        <label for="black-name--modal"><i class="fa fa-circle" aria-hidden="true" id="icon--black"></i> <span id="black-name--modal">Black</span></label>
                        <input name="black-name--modal" type="text" class="form-control">
                    </div>                
                    <div class="modal-col">
                        <label for="yellow-name--modal"><i class="fa fa-circle" aria-hidden="true" id="icon--yellow"></i> <span id="yellow-name--modal">Yellow</span></label>
                        <input name="yellow-name--modal" type="text" class="form-control">
                    </div>
                  </div>
                  <div class="modal-row">
                    <div class="modal-col">
                        <input name="black-score--modal" type="text" value="{{gameObject.blackScore}}" class="form-control">
                    </div>
                    <div class="modal-col">
                      <input name="yellow-score--modal" type="text" value="{{gameObject.yellowScore}}" class="form-control">
                    </div>                
                  </div>
                </div>
              </px-modal>

              <button id="button--save-game" type="button" class="menu-button btn btn--call-to-action btn--disabled">Save</button>
            </div>

            <!-- Yellow side -->
            <div id="container--player-scoreboard">
              <div id="container--player-details">
                <p>
                  <i class="fa fa-circle" aria-hidden="true" id="icon--yellow"></i>
                  <span id="yellow--name" class="name"></span>
                </p>
              </div>
              <p id="yellow--score" class="score">{{gameObject.yellowScore}}</p>
            </div>
          </div>
      </div>
    </body>
      <button on-tap="_updateGame">Update</button>
    </template>
  </template>

    <!-- Network requests -->
    <iron-ajax  
      auto
      id="req-get-gameObj" 
      method="get"
      url="/api/v1/game/" 
      handle-as="json"
      on-response="_handleGetGameObj" 
      on-error="_handleNetworkError">
    </iron-ajax>
    <iron-ajax 
      id="req-start-socket" 
      url="http://localhost:5000/api/v1/queue/startSocket" 
      on-response="_handleStartSocketRequest" 
      on-error="_handleNetworkError">
    </iron-ajax>
    <iron-ajax 
      id="req-restart-game" 
      method="get"
      url="/api/v1/game/restartGame"
      on-response="_handleRestartGame" 
      on-error="_handleNetworkError">
    </iron-ajax>
    <iron-ajax 
      id="req-quit-game" 
      method="get"
      url="/api/v1/game/quitGame"
      on-response="_handleQuitGame" 
      on-error="_handleNetworkError">
    </iron-ajax>
    <iron-ajax 
      id="req-update-timer" 
      method="put"
      content-type="application/json"
      url="/api/v1/game/updateTimer"
      on-error="_handleNetworkError">
  </iron-ajax>
  <iron-ajax
    id="req-update-rankings"
    method="get"
    url="/api/v1/game/updateRankings"
    on-response="_logRankings"
    on-error="handleNetworkError">
  </iron-ajax>
  <iron-ajax
    id="req-read-game-state"
    method="get"
    url="/api/v1/game/gameState"
    content-type="application/json"
    on-response="_handleUpdatedTimer"
    on-error="handleNetworkError">
</iron-ajax>
  </template>
  <script>
    Polymer({
      is: 'scoreboard-view',
      
      properties: { 
        pageIsLoading: {type: Boolean, value: true},

        pageHasError: { value: Boolean, value: false },

        gameObjectReceived: {type: Boolean, value: false},

        error: { type: String, value: "" },

        gameObject: { type: Object, value: {} },

        socket: { type: Object, value: null },

        timer: { type: Object, value: {"minutes": "00", "seconds": "00"} },

        gamePaused: { type: Boolean, value: false},

        gameOver: { type: Boolean, value: false},

        owner: { type: Boolean, value: false}
      },

      _startGame: function() {
        console.log("starting game");
        console.log("starting time");
        this._startTime();
        // this._startSocket();
      },

      _loadPageContent: function() {
        if(this.gameObjectReceived === true) {
          this._startGame();
          this.pageIsLoading = false;
        }
      },

      _updateGame: function() {
        console.log("tapped");
        let request = document.getElementById("req-update-rankings");
        request.generateRequest();
      },

      _logRankings: function(data) {
        console.log(data);
      },

      _checkGameState: function(game) {
        if (game.yellowScore >= 5 && game.yellowScore - game.blackScore >= 2) {
          console.log("yellow wins");
        }

        else if (game.blackScore >= 5 && game.blackScore - game.yellowScore >= 2) {
          console.log("black wins");
        }
      },

      _startTime: function() {
        if(!this.gameObject.gamePaused && !this.gameOver) {
          let request = document.getElementById("req-read-game-state");
          request.generateRequest();

          // If the game is not paused, update the time
          var t = setTimeout(this._startTime.bind(this), 1000);
        }
      },

      /**
       * Formats input unit of time with leading zero if less than 10
       * @param {int} unit 
       * Return String
       */
      _formatTime: function(unit) {
        var stringUnit = "" + unit;
        if (unit < 10 && stringUnit.length < 2) {unit = "0" + unit};
        return unit;
      },

      /**
       * Send request to restart game
       */ 
      _restartGame: function() {
        let request = document.getElementById("req-restart-game");
        request.generateRequest();
      },
      
      /**
       * Send request to quit game
       */ 
      _quitGame: function() {
        let request = document.getElementById("req-quit-game");
        request.generateRequest();
      },

      /**
       * Return to Lobby
       */
       _handleQuitGame: function() {
        location.reload();
      },

      /**
       * Get and set the gameObject after timer has been updated
       * 
       * @param data is the response body received from the server
       */    
       _handleUpdatedTimer: function(data) {
        let state = JSON.parse(data.detail.response.state);
        let game = state.game;
        this.set("gameObject", game);
        this.set("gameObjectReceived", true);
        console.log(this.gameObject.timer);

        let seconds = this.gameObject.timer.seconds;
          let minutes = this.gameObject.timer.minutes;
          seconds++;

          if (seconds == 60){
            minutes++;
            seconds = 0;
          }

          // Format the time
          this.set("gameObject.timer.minutes", this._formatTime(minutes));
          this.set("gameObject.timer.seconds", this._formatTime(seconds));
          console.log(this.gameObject.timer);
          // If the game is not paused, update the time
          console.log("updated time");

          if (this.owner) {
            let request = document.getElementById("req-update-timer");
            request.body = {"game":this.gameObject};
            request.generateRequest();
          }
      },

      /**
       * Get and set the gameObject on initial load of game or restart
       * 
       * @param data is the response body received from the server
       */    
       _handleRestartGame: function(data) {
        this.set("gameObject", data.detail.response.game);
        this.set("gameObjectReceived", true);
      },

      /**
       * Get and set the gameObject on initial load of game or restart
       * 
       * @param data is the response body received from the server
       */    
       _handleGetGameObj: function(data) {
         console.log("handling game obj");
         if (data.detail.response.game.activated) {
           console.log("not the owner");
           this.set("owner", false);
         }
         else {
           console.log("the owner");
           this.set("owner", true);
         }
          this.set("gameObject", data.detail.response.game);
          this.set("gameObjectReceived", true);
          this._loadPageContent();
          this._checkGameState(data.detail.response.game);
      },

      _handleStartSocketRequest: function() {
        console.log("started");
      },

      _handleCloseSocketRequest: function() {
        console.log("closed");
      },

      /**
       * If there is a network request error notify the user
       * 
       * @param data is the the response body received from the server
       */
       _handleNetworkError: function(data) {
        this.set("pageHasError", true);
        this.set("error", data.detail.error + ' - ' + data.detail.request.baseURI);
        this.set("pageIsLoading", false);
      },

      _startSocket: function() {
        console.log('starting socket');
        if (this.socket === null) {
          console.log("hhsadk;fj");
          let _this = this;
          this.set("socket", io.connect('http://localhost:5000'));
          this.socket.on('update-game-object', function (data) {
            console.log("got goal");
            if (data === "3") {
              _this._updateGame();
            }
          });
        }
      }
    });
  </script>
</dom-module>