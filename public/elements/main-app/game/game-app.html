<!-- Polymer -->
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- Predix UI Elements -->
<link rel="import" href="../../../bower_components/px-theme/px-theme-styles.html">
<link rel="import" href="../../../bower_components/px-progress-bar/px-progress-bar.html">

<!-- Custom views -->
<link rel="import" href="./views/lobby-view.html">
<link rel="import" href="./views/scoreboard-view.html">

<!-- Local theming -->
<link rel="import" href="./game-app-styles.html">

<dom-module id="game-app">
  <template>
    <!-- Global Predix theme -->
    <style include="px-theme-styles" is="custom-style"></style>

    <!-- Local theme -->
    <style include="game-app-styles" is="custom-style"></style>

    <!-- STATE: Page is loading -->
    <template is="dom-if" if="{{pageIsLoading}}">
      <px-progress-bar
        value="100"
        min="0"
        max="100"
        infinite>
      </px-progress-bar>
    </template>   
    <!-- STATE: Page is not loading -->
    <template is="dom-if" if="{{!pageIsLoading}}">
      <!-- STATE: Page is not loading and has an error -->
      <template is="dom-if" if="{{pageHasError}}">
        <div role="error" id="container--error">
          <h1>Error receiving data</h1>
          <p>Please report the following error message <a target="_blank" href="https://github.com/Foolish-Foosballers/Foosball-Front-End/issues">here</a>.</p>
          <div id="container--error-message">{{error}}</div>
        </div>
      </template>
      
      <!-- STATE: Page is not loading and does not have an error -->
      <template is="dom-if" if="{{!pageHasError}}">
        <!-- STATE: subroute = /#/game/lobby -->
        <template is="dom-if" if="[[_isLobbyView(route.path)]]">
          <lobby-view route="{{route}}"></lobby-view>
        </template>
    
        <!-- STATE: subroute = /#/game/scoreboard -->
        <template is="dom-if" if="[[_isScoreboardView(route.path)]]">
          <scoreboard-view route="{{route}}"></scoreboard-view>
        </template>
    
        <!-- STATE: route.path != /#/game/lobby/ && route.path != /#/game/scoreboard/ load the lobby view -->
        <template is="dom-if" if="[[_isInvalidView(route.path)]]"></template>
      </template>
    </template>
    
    <!-- Networking -->
    <iron-ajax 
      auto 
      id="req-get-gameObj" 
      method="get"
      url="/api/v1/game/" 
      handle-as="json"
      on-response="_handleGetGameObj" 
      on-error="_handleNetworkError">
    </iron-ajax>
  </template>
  <script>
    Polymer({
      is: 'game-app',

      properties: {
        // State of the page
        pageIsLoading: { value: Boolean, value: true },

        pageHasError: { value: Boolean, value: false },

        gameObjectReceived: { value: Boolean, value: false },

        // Error value
        error: { type: String, value: "" },

        // Game object
        gameObject: { type: Object, value: {} }
      },

      /**
       * Decide if the page content should be loaded. Load the page if all data is received
       */
       _loadPageContent: function() {
        if (this.gameObjectReceived === true) {
          this.set("pageHasError", false);
          this.set("pageIsLoading", false);
        }
      },

      /**
       * Get and set the gameObject
       * 
       * @param data is the response body received from the server
       */    
       _handleGetGameObj: function(data) {
        this.set("gameObject", data.detail.response.game);
        this.set("gameObjectReceived", true);
        this._loadPageContent();
      },

      /**
       * If there is a network request error notify the user
       * 
       * @param data is the the response body received from the server
       */
       _handleNetworkError: function(data) {
        this.set("pageHasError", true);
        this.set("error", data.detail.error + ' - ' + data.detail.request.baseURI);
        this.set("pageIsLoading", false);
      },

      _isLobbyView: function(view) {
        if (view == "/lobby") {
          this.set("pageIsLoading", false);
          return true;
        }
        return false;
      },

      _isScoreboardView: function(view) {
        if (view == "/scoreboard") {
          this.set("pageIsLoading", false);
          return true;
        }
        return false;        
      },

      _isInvalidView: function(view) {
        if (view != "/scoreboard" && view != "/lobby" ) {
          this._updatePath("/lobby");
          this.set("pageIsLoading", false);
          return true;
        }
        return false;       
      },

      _updatePath: function(path) {
        this.set("route.path", path);
      }
    });
  </script>
</dom-module>